name: CI Pipeline

on:
  push:
    branches: [ main, "rc/*" ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Lint with ruff
        run: |
          uv run ruff check .
          uv run ruff format --check .
      - name: Lint Dockerfile with hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: info

      - name: Verify Output Schema conformance
        run: |
          uv run python -c "import json; from src.state import AuditReport; json.dump(AuditReport.model_json_schema(), open('schema.json', 'w', encoding='utf-8'), indent=2)"
          if ! git diff --exit-code schema.json; then
            echo "::error::Schema drift detected! Run the schema generation command and commit 'schema.json' to fix."
            exit 1
          fi

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Generate Requirements for pip-audit
        run: uv export --format requirements-txt > requirements.txt
      - name: Security Audit with pip-audit
        uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          inputs: requirements.txt

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Run Tests with Coverage
        run: |
          uv run pytest tests/ --cov=src --cov-report=xml --cov-fail-under=80
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker Image
        run: |
          make docker-build
      - name: Cleanup build artifacts
        if: always()
        run: |
          docker system prune -f
